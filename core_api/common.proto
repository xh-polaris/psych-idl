syntax = "proto3";

package core_api;

option go_package = "core_api";

import "basic/pagination.proto";
import "google/protobuf/struct.proto";
import "profile/common.proto";


// 所有的core_api的resp需要统一增加code:255和msg:256

/* core_api */

message UserSignInReq {
  string unitId = 1;
  int32 authType = 2;
  string authId = 3;
  string verifyCode = 4;
}
message UserSignInResp {
  string unitId = 1;
  string userId = 2;
  string codeType = 3;
  string codeValue = 4;
  string token = 5;
  int32 code = 255;
  string msg = 256;
}

// 获取信息
message UserGetInfoReq {
}
message UserGetInfoResp {
  profile.User user = 1;
  int32 code = 255;
  string msg = 256;
}

/* dashboard */

// 数据看板
message DashboardGetDataOverviewReq {
  optional string unitId = 1;
}
message DashboardGetDataOverviewResp {
  int32 totalUsers = 1;
  int32 weeklyIncreaseUsers = 2;
  double weeklyIncreaseUsersRate = 3;
  optional int32 activeUsers = 4;
  optional int32 weeklyIncreaseActiveUsers = 5;
  optional double weeklyIncreaseActiveUsersRate = 6;
  int32 totalConversations = 7;
  int32 weeklyIncreaseConversations = 8;
  double weeklyIncreaseConversationsRate = 9;
  double averageTimePerConversation = 10; // minutes
  double weeklyIncreaseAverageTimePerConversation = 11; // minutes
  double weeklyIncreaseAverageTimePerConversationRate = 12;
  int32 alarmUsers = 13;
  int32 weeklyIncreaseAlarmUsers = 14;
  double weeklyIncreaseAlarmUsersRate = 15;
  optional int32 totalUnits = 16;
  optional int32 weeklyIncreaseUnits = 17;
  optional double weeklyIncreaseUnitsRate = 18;
  int32 code = 255;
  string msg = 256;
}

message DashboardGetDataTrendReq {
  string unitId = 1;
}
message DashboardGetDataTrendResp {
  repeated TrendPoint activePoints = 1;
  repeated TrendPoint conversationPoints = 2;
  repeated conversationDuration conversationDurations = 3;
  int32 code = 255;
  string msg = 256;
}
message TrendPoint {
  int32 week = 1;     // 1=Mon ... 7=Sun
  int32 hour = 2;        // 0–23
  int32 count = 3;
}
message conversationDuration {
  int32 minutes = 1;
  int32 count = 2;
}

message DashboardListUnitsReq {}
message DashboardListUnitsResp {
  repeated DashboardUnit units = 1;
  int32 code = 255;
  string msg = 256;
}
message DashboardUnit {
  string type = 1;
  string name = 2;
  string property = 3;
  int32 userCount = 4;
  double averageConversationMinutes = 5;
  int32 riskUserCount = 6;
  int64 updateTime = 7;
}

message DashboardGetPsycheTrendReq {
  string unitId = 1;
}
message DashboardGetPsycheTrendResp {
  repeated RiskDistribution risks = 1;
  repeated Keyword keywords = 2;
  int32 code = 255;
  string msg = 256;
}
message RiskDistribution {
  int32 level = 1; // 0=正常 1=低危 2=中危 3=高危
  int32 gender = 2; // 0=all 1=male 2=female
  int32 count = 3;
}
message Keyword {
  string keyword = 1;
  int32 count = 2;
}



// 预警管理
message DashboardGetAlarmOverviewReq {
  string unitId = 1;
}
message DashboardGetAlarmOverviewResp {
  int32 total = 1;      // 当前高风险用户总数
  int32 processed = 2;  // 当前已处理数
  int32 pending = 3;    // 当前待处理数
  int32 track = 4;      // 当前需追踪数
  double totalChange = 5;      // 对比上周总数变化百分比
  double processedChange = 6;  // 对比上周已处理变化百分比
  double pendingChange = 7;    // 对比上周待处理变化百分比
  double trackChange = 8;      // 对比上周需追踪变化百分比
  int32 code = 255;
  string msg = 256;
}

message DashboardListAlarmRecordsReq {
  string unitId = 1;
  optional string emotion = 2;
  optional string status = 3;
  optional string keyword = 4;
  basic.PaginationOptions paginationOptions = 5;
}
message DashboardListAlarmRecordsResp {
  repeated AlarmRecord records = 1;
  basic.Pagination pagination = 2;
  int32 code = 255;
  string msg = 256;
}

message AlarmRecord {
  string id = 1;  // 唯一Id
  string emotion = 2;  // 情绪状态
  repeated string keywords = 3;  // 关键词列表
  string status = 4;  // 处理状态
  profile.User user = 5;  // 用户信息
  int32  totalConversationRounds = 6;  // 总对话轮数
  int64  lastConversationTime = 7;  // 上次对话时间（分钟时间戳）
}



// 用户管理
message ClassInfo {
  int32 class = 1;
  int32 UserNum = 2;
  int32 alarmNum = 3;
  string teacherName = 4;
  string teacherPhone = 5;
}

message GradeInfo {
  int32 grade = 1;
  repeated ClassInfo classes = 2;
}

message DashboardListClassesReq {
  string unitId = 1;
  optional int32 grade = 2;
  optional int32 class = 3;
}
message DashboardListClassesResp {
  repeated GradeInfo grades = 1;
  int32 code = 255;
  string msg = 256;
}

message RiskUser {
  profile.User user = 1;
  int32 level = 2;
  int32  totalConversationRounds = 3;  // 总对话轮数
  int64  lastConversationTime = 4;  // 上次对话时间（分钟时间戳）
  repeated string keywords = 5;
}

message DashboardListUsersReq{
  string unitId = 1;
  optional int32 level = 2;
  optional string gender = 3;
  optional string keyword = 4;
  basic.PaginationOptions paginationOptions = 5;
}
message DashboardListUsersResp {
  repeated RiskUser riskUsers = 1;
  basic.Pagination pagination = 2;
  int32 code = 255;
  string msg = 256;
}