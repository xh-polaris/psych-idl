syntax = "proto3";

package core_api;

option go_package = "core_api";

import "basic/pagination.proto";
import "google/protobuf/struct.proto";
import "profile/common.proto";
import "google/protobuf/any.proto";
import "basic/http.proto";
// 所有的core_api的resp需要统一增加code:255和msg:256

/* core_api */

// 获取信息
message UserGetInfoReq {
  string userId = 1[(http.query) = "userId"];
}
message UserGetInfoResp {
  profile.User user = 1;
  int32 code = 255;
  string msg = 256;
}

/* dashboard */

// 数据看板
message DashboardGetDataOverviewReq {
  optional string unitId = 1[(http.query) = "unitId"];
}
message DashboardGetDataOverviewResp {
  int64 totalUsers = 1;
  int64 weeklyIncreaseUsers = 2;
  double weeklyIncreaseUsersRate = 3;
  optional int64 activeUsers = 4;
  optional int64 weeklyIncreaseActiveUsers = 5;
  optional double weeklyIncreaseActiveUsersRate = 6;
  int64 totalConversations = 7;
  int64 weeklyIncreaseConversations = 8;
  double weeklyIncreaseConversationsRate = 9;
  double averageTimePerConversation = 10; // minutes
  double weeklyIncreaseAverageTimePerConversation = 11; // minutes
  double weeklyIncreaseAverageTimePerConversationRate = 12;
  int64 alarmUsers = 13;
  int64 weeklyIncreaseAlarmUsers = 14;
  double weeklyIncreaseAlarmUsersRate = 15;
  optional int64 totalUnits = 16;
  optional int64 weeklyIncreaseUnits = 17;
  optional double weeklyIncreaseUnitsRate = 18;
  int32 code = 255;
  string msg = 256;
}

message DashboardGetDataTrendReq {
  optional string unitId = 1[(http.query) = "unitId"];
}
message DashboardGetDataTrendResp {
  repeated TrendPoint activePoints = 1;
  repeated TrendPoint conversationPoints = 2;
  repeated conversationDuration conversationDurations = 3;
  int32 code = 255;
  string msg = 256;
}
message TrendPoint {
  int32 week = 1;     // 1=Mon ... 7=Sun
  int32 hour = 2;        // 0–23
  int64 count = 3;
}
message conversationDuration {
  int32 minutes = 1;
  int64 count = 2;
}

message DashboardListUnitsReq {}
message DashboardListUnitsResp {
  repeated DashboardUnit units = 1;
  int32 code = 255;
  string msg = 256;
}
message DashboardUnit {
  string type = 1;
  string name = 2;
  string property = 3;
  int64 userCount = 4;
  double averageConversationMinutes = 5;
  int64 riskUserCount = 6;
  int64 updateTime = 7;
}

message DashboardGetPsychTrendReq {
  string unitId = 1[(http.query) = "unitId"];
}
message DashboardGetPsychTrendResp {
  repeated RiskDistribution risks = 1;
  repeated Keyword keywords = 2;
  int32 code = 255;
  string msg = 256;
}
message RiskDistribution {
  int32 level = 1; // 0=正常 1=低危 2=中危 3=高危
  int32 gender = 2; // 0=all 1=male 2=female
  int64 count = 3;
}
message Keyword {
  string keyword = 1;
  int64 count = 2;
}



// 预警管理
message DashboardGetAlarmOverviewReq {
  string unitId = 1[(http.query) = "unitId"];
}
message DashboardGetAlarmOverviewResp {
  int32 total = 1;      // 当前高风险用户总数
  int32 processed = 2;  // 当前已处理数
  int32 pending = 3;    // 当前待处理数
  int32 track = 4;      // 当前需追踪数
  double totalChange = 5;      // 对比上周总数变化百分比
  double processedChange = 6;  // 对比上周已处理变化百分比
  double pendingChange = 7;    // 对比上周待处理变化百分比
  double trackChange = 8;      // 对比上周需追踪变化百分比
  int32 code = 255;
  string msg = 256;
}

message DashboardListAlarmRecordsReq {
  string unitId = 1[(http.query) = "unitId"];
  optional string emotion = 2[(http.query) = "emotion"];
  optional string status = 3[(http.query) = "status"];
  optional string keyword = 4[(http.query) = "keyword"];
  basic.PaginationOptions paginationOptions = 5;
}
message DashboardListAlarmRecordsResp {
  repeated AlarmRecord records = 1;
  basic.Pagination pagination = 2;
  int32 code = 255;
  string msg = 256;
}

message AlarmRecord {
  string id = 1;  // 唯一Id
  string emotion = 2;  // 情绪状态
  repeated string keywords = 3;  // 关键词列表
  string status = 4;  // 处理状态
  profile.User user = 5;  // 用户信息
  int32  totalConversationRounds = 6;  // 总对话轮数
  int64  lastConversationTime = 7;  // 上次对话时间（分钟时间戳）
}



// 用户管理
message ClassInfo {
  int32 class = 1;
  int32 userNum = 2;
  int32 alarmNum = 3;
  string teacherName = 4;
  string teacherPhone = 5;
}

message GradeInfo {
  int32 grade = 1;
  repeated ClassInfo classes = 2;
}

message DashboardListClassesReq {
  string unitId = 1[(http.query) = "unitId"];
  optional int32 grade = 2[(http.query) = "grade"];
  optional int32 class = 3[(http.query) = "class"];
}
message DashboardListClassesResp {
  repeated GradeInfo grades = 1;
  int32 code = 255;
  string msg = 256;
}

message RiskUser {
  profile.User user = 1;
  int32 level = 2;
  int32  totalConversationRounds = 3;  // 总对话轮数
  int64  lastConversationTime = 4;  // 上次对话时间（分钟时间戳）
  repeated string keywords = 5;
}

message DashboardListUsersReq{
  string unitId = 1[(http.query) = "unitId"];
  optional int32 level = 2[(http.query) = "level"];
  optional string gender = 3[(http.query) = "gender"];
  optional string keyword = 4[(http.query) = "keyword"];
  basic.PaginationOptions paginationOptions = 5;
}
message DashboardListUsersResp {
  repeated RiskUser riskUsers = 1;
  basic.Pagination pagination = 2;
  int32 code = 255;
  string msg = 256;
}



// 原profile相关
/* User */
message User {
  string id = 1;
  string codeType = 2;
  string code = 3;
  string password = 4;
  string unitId = 5;
  string name = 6;
  int64 birth = 7;
  string gender = 8;
  string status = 9;
  int32 enrollYear = 10;
  int32 grade = 11;
  int32 class = 12;
  map<string, google.protobuf.Any> options = 13;
  int64 createTime = 14;
  int64 updateTime = 15;
  int64 deleteTime = 16;
}

// 注册相关
message UserSignUpReq {
  User user = 1;
}
message UserSignUpResp {
  User user = 1;
  int32 code = 255;
  string msg = 256;
}

message UserSignInReq {
  string unitId = 1;
  int32 authType = 2;
  string authId = 3;
  string verifyCode = 4;
}
message UserSignInResp {
  string unitId = 1;
  string userId = 2;
  string codeType = 3;
  string codeValue = 4;
  string token = 5;
  int32 code = 255;
  string msg = 256;
}

// 更新信息
message UserUpdateInfoReq {
  User user = 1;
}

// 更新密码
message UserUpdatePasswordReq {
  string id = 1;
  int32 authType = 2;
  string verifyCode = 3;
  string newPassword = 4;
}

/* Unit */
message Unit {
  string id = 1;
  string phone = 2;
  string password = 3;
  string name = 4;
  string address = 5;
  string contact = 6;
  int32 level = 7;
  string status = 8;
  int64 createTime = 9;
  int64 updateTime = 10;
  int64 deleteTime = 11;
}

// 注册相关
message UnitSignUpReq {
  Unit unit = 1;
}
message UnitSignUpResp {
  Unit unit = 1;
  int32 code = 255;
  string msg = 256;
}

// 登录相关
message UnitSignInReq {
  int32 authType = 1;
  string authId = 2;
  string verifyCode = 3;
}
message UnitSignInResp {
  string unitId = 1;
  int32 code = 255;
  string msg = 256;
}

// 获取信息
message UnitGetInfoReq {
  string unitId = 1[(http.query) = "unitId"];
}
message UnitGetInfoResp {
  Unit unit = 1;
  int32 code = 255;
  string msg = 256;
}

// 更新信息
message UnitUpdateInfoReq {
  Unit unit = 1;
}

// 更新密码
message UnitUpdatePasswordReq {
  string id = 1;
  int32 authType = 2;
  string verifyCode = 3;
  string newPassword = 4;
}

// 关联用户
message UnitLinkUserReq {
  string unitId = 1;
  string userId = 2;
}

// 创建并关联用户
message UnitCreateAndLinkUserReq {
  string unitId = 1;
  string codeType = 2;
  repeated User users = 3;
}
message UnitCreateAndLinkUserResp {
  int32 allCount = 1;
  int32 successCount = 2;
  int32 skipCount = 3;
  int32 code = 255;
  string msg = 256;
}

/*Config*/
message ChatApp {
  string name = 1;
  string description = 2;
  string provider = 3;
  string appId = 4;
};

message TTSApp {
  string name = 1;
  string description = 2;
  string provider = 3;
  string appId = 4;
  string speaker = 5;
};

message ReportApp {
  string name = 1;
  string description = 2;
  string provider = 3;
  string appId = 4;
}

message Config {
  string unitId = 1;
  string type = 2; // chain | end2end
  ChatApp chat = 3;
  TTSApp tts = 4;
  ReportApp report = 5;
  string status = 6; // active | deleted
  int64 createTime = 7;
  int64 updateTime = 8;
}

message ConfigCreateOrUpdateReq {
  Config config = 1;
  bool admin = 2;
}

message ConfigGetByUnitIdReq {
  string unitId = 1[(http.query) = "unitId"];
  bool admin = 2[(http.query) = "admin"];
}
message ConfigGetByUnitIdResp {
  Config config = 1;
  int32 code = 255;
  string msg = 256;
}
